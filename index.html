<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Discord OAuth Example</title>
    <style>
      .hidden {
        display: none;
      }
      .feature-chip {
        display: inline-block;
        padding: 0.5rem;
        margin: 0.5rem;
        border-radius: 0.5rem;
        background-color: #7289da;
        color: white;
        cursor: pointer;
      }

      .feature-chip.active {
        background-color: #ff3e3e;
        color: #fff;
      }
    </style>
  </head>

  <body>
    <p>Created by ChatGPT (with some minimal edits from <a href="https://zyplos.dev">me</a>)</p>
    <button onclick="login()">Login with Discord</button>
    <script>
      const CLIENT_ID = "<your client id here>";
      const REDIRECT_URI = "http://localhost:3000";

      function getGuilds(token) {
        fetch("https://discord.com/api/users/@me/guilds", {
          headers: {
            authorization: `Bearer ${token}`,
          },
        })
          .then((response) => response.json())
          .then((guilds) => displayGuilds(guilds))
          .catch((error) => {
            console.error(error);
            localStorage.removeItem("token");
            getToken();
          });
      }

      function getToken() {
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        const token = params.get("access_token");
        if (token) {
          localStorage.setItem("token", token);
          getGuilds(token);
        } else {
          const savedToken = localStorage.getItem("token");
          if (savedToken) {
            getGuilds(savedToken);
          } else {
            window.location.href = `https://discord.com/api/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=token&scope=identify%20guilds`;
          }
        }
      }

      getToken();

      function displayGuilds(guilds) {
        const guildsContainer = document.createElement("div");
        document.body.appendChild(guildsContainer);

        const filterContainer = document.createElement("div");
        filterContainer.classList.add("filter-container");
        guildsContainer.appendChild(filterContainer);

        const featuresContainer = document.createElement("div");
        featuresContainer.classList.add("features-container");
        filterContainer.appendChild(featuresContainer);

        const searchBox = document.createElement("input");
        searchBox.classList.add("search-box");
        searchBox.type = "text";
        searchBox.placeholder = "Search by feature";
        filterContainer.appendChild(searchBox);

        const getGuildFeatures = (guild) => guild.features.map((feature) => feature.toLowerCase());

        const uniqueFeatures = guilds
          .map(getGuildFeatures)
          .flat()
          .filter((feature, index, array) => array.indexOf(feature) === index);

        const filterGuilds = (feature) => {
          featuresContainer.querySelectorAll(".feature-chip").forEach((chip) => {
            if (chip.textContent.toLowerCase() === feature) {
              chip.classList.add("active");
            } else {
              chip.classList.remove("active");
            }
          });
          guildsContainer.querySelectorAll(".guild-info").forEach((guildInfo) => {
            if (guildInfo.dataset.features.includes(feature)) {
              guildInfo.classList.remove("hidden");
            } else {
              guildInfo.classList.add("hidden");
            }
          });
        };

        uniqueFeatures.forEach((feature) => {
          const featureChip = document.createElement("span");
          featureChip.classList.add("feature-chip");
          featureChip.textContent = feature;
          featureChip.addEventListener("click", () => {
            filterGuilds(feature);
            featuresContainer.querySelectorAll(".feature-chip").forEach((chip) => {
              if (chip.textContent.toLowerCase() === feature) {
                chip.classList.add("active");
              } else {
                chip.classList.remove("active");
              }
            });
          });
          featuresContainer.appendChild(featureChip);
        });

        searchBox.addEventListener("input", () => {
          const searchValue = searchBox.value.trim().toLowerCase();
          guildsContainer.querySelectorAll(".guild-info").forEach((guildInfo) => {
            if (guildInfo.dataset.features.includes(searchValue)) {
              guildInfo.classList.remove("hidden");
            } else {
              guildInfo.classList.add("hidden");
            }
          });
        });

        guilds.forEach((guild) => {
          const guildInfo = document.createElement("div");
          guildInfo.classList.add("guild-info");
          guildInfo.dataset.features = getGuildFeatures(guild).join(",");
          guildInfo.innerHTML = `
      <h2>${guild.name}</h2>
      <img src="https://cdn.discordapp.com/icons/${guild.id}/${guild.icon}.png">
      <p>Owner: ${guild.owner ? "Yes" : "No"}</p>
      <p>Features: ${guild.features.join(", ")}</p>
    `;
          guildsContainer.appendChild(guildInfo);
        });
      }
    </script>
  </body>
</html>
